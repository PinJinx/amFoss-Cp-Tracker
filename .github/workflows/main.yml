# .github/workflows/update-leaderboard.yml
#
# Triggers on PRs opened/updated against a date-named branch (YYYY-MM-DD).
# Flow:
#   1. Reject immediately if PR targets `main`
#   2. Count added screenshot files under  member/<pr-author>/
#   3. Update Supabase leaderboard via update.js
#   4. Auto-merge the PR into the date branch
#
# â”€â”€ Required: Repository secrets (Settings â†’ Secrets â†’ Actions) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   SUPABASE_URL  â€“ https://xyzxyz.supabase.co
#   SUPABASE_KEY  â€“ service_role key (NOT anon key)
#   PAT_TOKEN     â€“ Personal Access Token with `repo` scope
#
# âš ï¸  Do NOT use GitHub Environment secrets with pull_request triggers â€”
#     GitHub blocks environment secrets on PR events for security reasons.
#     Add secrets at the REPOSITORY level instead.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Update Leaderboard

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    # âš ï¸  NO `environment:` here â€” environment secrets don't work on pull_request
    #     triggers. Use repository-level secrets instead.

    permissions:
      pull-requests: write
      contents: write

    steps:
      # â”€â”€ 0. Block PRs targeting main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Block PRs targeting main
        if: github.event.pull_request.base.ref == 'main'
        run: |
          echo "âŒ  This PR targets 'main'. Submissions must target a date branch (YYYY-MM-DD)."
          exit 1

      # â”€â”€ 0b. Validate the target branch is YYYY-MM-DD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validate date branch format
        id: validate
        run: |
          BRANCH="${{ github.event.pull_request.base.ref }}"
          if [[ ! "$BRANCH" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "âŒ  Target branch '$BRANCH' is not a date branch (expected YYYY-MM-DD)."
            exit 1
          fi
          echo "âœ…  Target branch: $BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}  # check out the PR branch, not base

      # â”€â”€ 2. Node setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # â”€â”€ 3. Install deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: npm install @supabase/supabase-js

      # â”€â”€ 4. Get added files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get changed files
        id: changed
        run: |
          git fetch origin ${{ steps.validate.outputs.branch }}

          FILES=$(git diff --name-only --diff-filter=A \
            origin/${{ steps.validate.outputs.branch }}...HEAD)

          echo "Added files in this PR:"
          echo "$FILES"

          {
            echo "FILES<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # â”€â”€ 5. Run update.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update Supabase leaderboard
        id: update
        env:
          SUPABASE_URL:        ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY:        ${{ secrets.SUPABASE_KEY }}
          GITHUB_TOKEN:        ${{ secrets.PAT_TOKEN }}
          PR_AUTHOR:           ${{ github.event.pull_request.user.login }}
          CHANGED_FILES:       ${{ steps.changed.outputs.FILES }}
          DATE_BRANCH:         ${{ github.event.pull_request.base.ref }}
          POINTS_PER_QUESTION: "10"
        run: node LeaderBoard/src/update.js

      # â”€â”€ 6. Comment on PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const author = context.payload.pull_request.user.login;
            const branch = context.payload.pull_request.base.ref;

            const raw    = `${{ steps.changed.outputs.FILES }}`;
            const prefix = `Members/${author.toLowerCase()}/`;
            const files  = raw.split('\n')
              .map(f => f.trim())
              .filter(f => f.startsWith(prefix) && !f.endsWith('/') && f !== prefix);
            const count = files.length;
            const pts   = count * 10;

            const body = [
              `## âœ… Leaderboard Updated!`,
              ``,
              `| | |`,
              `|---|---|`,
              `| ğŸ‘¤ **User** | \`${author}\` |`,
              `| ğŸ“ **Questions submitted** | ${count} |`,
              `| â­ **Points earned** | +${pts} |`,
              `| ğŸ“… **Submitted to** | \`${branch}\` |`,
              ``,
              `_Merging this PR into \`${branch}\` nowâ€¦_`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

      # â”€â”€ 7. Auto-merge into the date branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr     = context.payload.pull_request;
            const author = pr.user.login;
            const branch = pr.base.ref;

            await github.rest.pulls.merge({
              owner:          context.repo.owner,
              repo:           context.repo.repo,
              pull_number:    pr.number,
              commit_title:   `chore: add ${author}'s questions [${branch}]`,
              commit_message: `Auto-merged by leaderboard workflow after updating Supabase.`,
              merge_method:   "squash",
            });

            console.log(`âœ…  PR #${pr.number} merged into ${branch}`);